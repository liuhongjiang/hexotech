<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Enable https and tokenless auth for keystone | Andrew&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="enable https for keystone
actually it’s quite easy, first you need load mod_ssl module of apache, then only thing you need to do is change the wsgi-keystone.conf:
like this: 1234567&amp;lt;VirtualHost *">
<meta property="og:type" content="article">
<meta property="og:title" content="Enable https and tokenless auth for keystone">
<meta property="og:url" content="http://liuhongjiang.github.io/2016/12/23/enable-https-and-tokenless-auth-for-keystone/index.html">
<meta property="og:site_name" content="Andrew's Blog">
<meta property="og:description" content="enable https for keystone
actually it’s quite easy, first you need load mod_ssl module of apache, then only thing you need to do is change the wsgi-keystone.conf:
like this: 1234567&amp;lt;VirtualHost *">
<meta property="og:updated_time" content="2016-12-30T03:33:28.461Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Enable https and tokenless auth for keystone">
<meta name="twitter:description" content="enable https for keystone
actually it’s quite easy, first you need load mod_ssl module of apache, then only thing you need to do is change the wsgi-keystone.conf:
like this: 1234567&amp;lt;VirtualHost *">
  
    <link rel="alternative" href="/atom.xml" title="Andrew&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/hexotech/images/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/hexotech/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/hexotech/" id="logo">Andrew&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/hexotech/">Home</a>
        
          <a class="main-nav-link" href="/hexotech/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://liuhongjiang.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-enable-https-and-tokenless-auth-for-keystone" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/hexotech/2016/12/23/enable-https-and-tokenless-auth-for-keystone/" class="article-date">
  <time datetime="2016-12-23T11:48:53.000Z" itemprop="datePublished">2016-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/hexotech/categories/keystone-openstack/">keystone, openstack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Enable https and tokenless auth for keystone
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="enable-https-for-keystone">enable https for keystone</h2>
<p>actually it’s quite easy, first you need load mod_ssl module of apache, then only thing you need to do is change the <a href="https://github.com/openstack/keystone/blob/master/httpd/wsgi-keystone.conf" target="_blank" rel="external">wsgi-keystone.conf</a>:</p>
<p>like this: <figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&lt;VirtualHost *:5000&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    SSLEngine <span class="keyword">on</span></span><br><span class="line">    SSLCertificateKeyFile /<span class="built_in">pass</span>/<span class="keyword">to</span>/key-file.pem</span><br><span class="line">    SSLCertificateFile /path/<span class="keyword">to</span>/server.cer</span><br><span class="line">    ...</span><br><span class="line"><span class="variable">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>if your server certificate is not signed by the root CA, then you need the intermediate CA certificates. please notice <code>SSLCertificateChainFile</code> became obsolete with version 2.4.8, when SSLCertificateFile was extended to also load intermediate CA certificates from the server certificate file.</p>
<a id="more"></a>
<h2 id="how-to-using-openstack-clint-to-connect-to-keystone-with-our-own-server-certificate">how to using openstack clint to connect to keystone with our own server certificate</h2>
<p>with our own server certificate, the openstack client will report the following error</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[andrew<span class="property">@localhost</span> certifi]$ openstack user list</span><br><span class="line">Discovering versions <span class="keyword">from</span> the identity service failed <span class="keyword">when</span> creating the password plugin. Attempting <span class="keyword">to</span> determine version <span class="keyword">from</span> URL.</span><br><span class="line">SSL exception connecting <span class="keyword">to</span> <span class="attribute">https</span>:<span class="pi">//test-os.andrew.com:5000/v3/auth/tokens: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:765)</span></span><br></pre></td></tr></table></figure>
<p>then you add your own CA certificate following <a href="/hexotech/2016/12/23/setup-your-own-ca/#for-python-requests-to-add-ca">this article</a>, it can be succeeded:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[andrew@localhost kolla]$ openstack user list</span><br><span class="line"><span class="code">+----------------------------------+</span>-------+</span><br><span class="line"><span class="header">| ID                               | Name  |</span><br><span class="line">+----------------------------------+-------+</span></span><br><span class="line"><span class="header">| ce52a85aea0f46abb3930d9c8f866131 | admin |</span><br><span class="line">+----------------------------------+-------+</span></span><br></pre></td></tr></table></figure>
<h2 id="enable-tokenless-author">enable tokenless author</h2>
<p>for this, please following the <a href="http://docs.openstack.org/developer/keystone/configure_tokenless_x509.html" target="_blank" rel="external">manual of the openstack</a>.</p>
<p>There some point you need know, in the apache configuration:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLCACertificatePath <span class="regexp">/etc/</span>apache2<span class="regexp">/capath</span></span><br></pre></td></tr></table></figure>
<p>you need put the CA certificates of CA who sign the clinet certificates in that directory, and you need to generated a hash-value symbolic file for it.</p>
<p>please refer to the section <code>generate hash-value for apache SSLCACertificatePath</code> Directive for details.</p>
<p>When config the trusted_issuer and generate IdP ID of the issuer_dn, you can using the following way to find it out.</p>
<p>Frist you need have one ‘trusted_issuer’ in your keystone.conf, if you didn’t, you can configure an arbitrary string, then using the curl command like this:</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -v -k -s -X GET --cert /home/andrew/CA/certs/client.cer \</span><br><span class="line">     -<span class="ruby">-key /home/andrew/<span class="constant">CA</span>/private/client-key-no-passwrod.pem \</span><br><span class="line"></span>     -<span class="ruby"><span class="constant">H</span> <span class="string">"X-Project-Name: admin"</span>      \</span><br><span class="line"></span>     -<span class="ruby"><span class="constant">H</span> <span class="string">"X-Project-Domain-Id: default"</span>    \      </span><br><span class="line"></span>     -<span class="ruby"><span class="constant">H</span> <span class="string">"X-Subject-Token: dfaa8c530cd548c59ae60ddce4fc594c"</span>      \</span><br><span class="line"></span>     https://test-os.andrew.com:5000/v3/auth/tokens</span><br></pre></td></tr></table></figure>
<p>then you can find the issues in the log</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2016-12-23 08:33:06.029 17 INFO keystone.middleware.auth [req-a7bcd1e9-77d7-44a6-be95-6d081680ef40 - - - - -] The client issuer CN=myname,<span class="keyword">OU</span>=mygroup,O=myorganization,<span class="keyword">L</span>=mycity,<span class="keyword">ST</span>=myprovince,C=CN does not match with the trusted issuer ['emailAddress=john@openstack.com,CN=john,<span class="keyword">OU</span>=keystone,O=openstack,<span class="keyword">L</span>=Sunnyvale,<span class="keyword">ST</span>=California,C=<span class="keyword">US</span>']</span><br></pre></td></tr></table></figure>
<p>the <code>CN=myname,OU=mygroup,O=myorganization,L=mycity,ST=myprovince,C=CN</code> is the issue dn you can user for trusted_issuer and generate IdP ID.</p>
<h2 id="generate-hash-value-for-apache-sslcacertificatepath-directive">generate hash-value for apache SSLCACertificatePath Directive</h2>
<p>http://httpd.apache.org/docs/current/mod/mod_ssl.html#SSLCACertificatePath</p>
<p>So usually you can’t just place the Certificate files there: you also have to create symbolic links named hash-value.N. And you should always make sure this directory contains the appropriate symbolic links.</p>
<p>in this article, it explained the reason:</p>
<p>https://blog.g3rt.nl/client-certificate-authentication-apache.html</p>
<p>Suppose you have hundreds of these certificates, then Apache would need to open every certificate until it finds the right one. You can imagine that would be very inefficient. To speed that up, Apache looks for a file with the hash of the certificate it gets from the client. For example, if my certificate would be hashed as 27e66395 then it would look for files with the name of 27e66395.X where X is a number starting with 0.</p>
<p>below command, you can find the hash value from the ca file.</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -noout -hash -<span class="keyword">in</span> NAME-<span class="keyword">OF</span>-CA-<span class="keyword">FILE</span></span><br></pre></td></tr></table></figure>
<h2 id="reference">Reference</h2>
<p><a href="http://www.florentflament.com/blog/setting-keystone-v3-domains.html" target="_blank" rel="external">using curl to requst keystone api</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuhongjiang.github.io/hexotech/2016/12/23/enable-https-and-tokenless-auth-for-keystone/" data-id="cixb80cnm0009f0i4eorlf5s2" class="article-share-link">Share</a>
      
        <a href="http://liuhongjiang.github.io/hexotech/2016/12/23/enable-https-and-tokenless-auth-for-keystone/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/hexotech/2016/12/23/setup-your-own-ca/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Setup your own CA</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/3rd-nbsp-tools/">3rd&nbsp;tools</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Algorithm/">Algorithm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/C-C/">C/C++</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Data-nbsp-structure/">Data&nbsp;structure</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Fuck-nbsp-GFW/">Fuck&nbsp;GFW</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Language/">Language</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Machine-nbsp-Learning/">Machine&nbsp;Learning</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/Vi/">Vi</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/git/">git</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/hadoop/">hadoop</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/javascript/">javascript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/jenkins/">jenkins</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/keystone-openstack/">keystone, openstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/linux/">linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/math/">math</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/octopress/">octopress</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/openssl/">openssl</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/openstack/">openstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/paper/">paper</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/hexotech/categories/sqlite/">sqlite</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/09/">September 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/08/">August 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/06/">June 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/05/">May 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2015/04/">April 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2014/05/">May 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2013/11/">November 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2013/08/">August 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2013/02/">February 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2013/01/">January 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2012/12/">December 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/hexotech/archives/2012/11/">November 2012</a><span class="archive-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/hexotech/2016/12/23/enable-https-and-tokenless-auth-for-keystone/">Enable https and tokenless auth for keystone</a>
          </li>
        
          <li>
            <a href="/hexotech/2016/12/23/setup-your-own-ca/">Setup your own CA</a>
          </li>
        
          <li>
            <a href="/hexotech/2016/10/11/atom-tips/">atom tips</a>
          </li>
        
          <li>
            <a href="/hexotech/2016/10/11/vagrant-multiple-vms/">vagrant multiple vms</a>
          </li>
        
          <li>
            <a href="/hexotech/2016/09/23/install-ceph-through-vagrant-on-centos7/">install ceph through vagrant on centos7</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Andrew Liu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/hexotech/" class="mobile-nav-link">Home</a>
  
    <a href="/hexotech/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'andrewliu117';
  
  var disqus_url = 'http://liuhongjiang.github.io/hexotech/2016/12/23/enable-https-and-tokenless-auth-for-keystone/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/hexotech/js/jquery-2.1.4.min.js" type="text/javascript"></script>

<!--<script type="text/x-mathjax-config">-->
<!--MathJax.Hub.Config({-->
  <!--tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}-->
<!--});-->
<!--</script>-->
<!--<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
<!--</script>-->


  <link rel="stylesheet" href="/hexotech/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/hexotech/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/hexotech/js/script.js" type="text/javascript"></script>



  </div>
</body>
</html>